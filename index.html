<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redeem Page</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">
  <h1>CHOOSE AN ITEM TO REDEEM WITH POINTS</h1>

  <div class="search-filter">
    <input id="searchInput" type="text" placeholder="Search by name or description..." />
    <select id="sortFilter" style="border: 2px solid #ddd; ">
      <option value="">Sort by</option>
      <option value="low-high">Points: Low to High</option>
      <option value="high-low">Points: High to Low</option>
    </select>
  </div>

  <div id="productList">
    <div class="loading">Loading products...</div>
  </div>
</div>

<!-- Popup -->
<div class="popup" id="popup">
  <div class="popup-content">
    <h2 id="popup-title"></h2>
    <p id="popup-desc"></p>
    <button class="close-btn" onclick="closePopup()">Close</button>
  </div>
</div>

<script>
  // Load products from JSON 
  async function loadProducts() {
    try {
      const response = await fetch('products.json');
      if (response.ok) {
        const products = await response.json();
        displayProducts(products);
      } else {
        throw new Error('products.json not found');
      }
    } catch (error) {
      console.log('Error loading products:', error);
     
      const productList = document.getElementById('productList');
      productList.innerHTML = '<div class="loading">No products found. Please make sure products.json exists.</div>';
    }
  }

  // Display products
  function displayProducts(products) {
    const productList = document.getElementById('productList');
    
    if (products.length === 0) {
      productList.innerHTML = '<div class="loading">No products available</div>';
      return;
    }
    
    productList.innerHTML = '';
    
    products.forEach(product => {
      const productDiv = document.createElement('div');
      productDiv.className = 'product';
      productDiv.innerHTML = `
        <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Found'">
        <div class="product-info">
          <div class="product-name">${product.name}</div>
          <div class="product-desc">${product.description}</div>
        </div>
        <div class="credits">${product.points} points</div>
        <button class="redeem-btn" onclick="redeemProduct('${product.name.replace(/'/g, "\\'")}', '${product.points} points')">REDEEM NOW</button>
      `;
      productList.appendChild(productDiv);
    });
    
  
    initializeFilters();
    applyDescriptionTruncation();
  }

  // Initialize search and filter functionality
  function initializeFilters() {
    const productList = document.getElementById('productList');
    const searchInput = document.getElementById('searchInput');
    const sortFilter = document.getElementById('sortFilter');
    
    const originalItems = Array.from(productList.querySelectorAll('.product'));

    function readpoints(el) {
      const txt = el.querySelector('.points')?.textContent || '';
      const n = parseInt(txt.replace(/[^\d]/g, ''), 10);
      return Number.isNaN(n) ? 0 : n;
    }

    function readSearchText(el) {
      const name = el.querySelector('.product-name')?.textContent || '';
      const desc = el.querySelector('.product-desc')?.textContent || '';
      return (name + ' ' + desc).toLowerCase();
    }

    function applyFilterAndSort() {
      const q = searchInput.value.trim().toLowerCase();
      const sortOrder = sortFilter.value;

      let filtered = originalItems.filter(el => {
        return readSearchText(el).includes(q);
      });

      if (sortOrder === 'low-high') {
        filtered.sort((a, b) => readpoints(a) - readpoints(b));
      } else if (sortOrder === 'high-low') {
        filtered.sort((a, b) => readpoints(b) - readpoints(a));
      }

      productList.innerHTML = '';
      filtered.forEach(el => {
        productList.appendChild(el);
      });
      
      applyDescriptionTruncation();
    }

    searchInput.addEventListener('input', applyFilterAndSort);
    sortFilter.addEventListener('change', applyFilterAndSort);
  }

  // "click for more" popup
  function applyDescriptionTruncation() {
    document.querySelectorAll('.product-desc').forEach(desc => {
      const fullText = desc.getAttribute('data-full') || desc.textContent.trim();
      desc.setAttribute('data-full', fullText);
      const maxLen = 120;
      if (fullText.length > maxLen) {
        const shortText = fullText.slice(0, maxLen) + '... ';
        desc.innerHTML = '';
        desc.appendChild(document.createTextNode(shortText));
        const moreLink = document.createElement('span');
        moreLink.textContent = 'click for more';
        moreLink.classList.add('click-more');
        moreLink.onclick = () => openPopup(desc.closest('.product').querySelector('.product-name').textContent, fullText);
        desc.appendChild(moreLink);
      } else {
        desc.textContent = fullText;
      }
    });
  }

  // Popup functions
  function openPopup(name, desc) {
    document.getElementById('popup-title').textContent = name;
    document.getElementById('popup-desc').textContent = desc;
    document.getElementById('popup').style.display = 'flex';
  }

  function closePopup() {
    document.getElementById('popup').style.display = 'none';
  }

  
 // Redeem button function
function redeemProduct(name, points) {
  // Replace these entry IDs with your actual formâ€™s entry IDs
  const productEntry = "entry.208538347"; // Product Name field
  const pointsEntry = "entry.704775185"; // points field

  // Your Google Form base URL (from pre-filled link)
  const baseURL = "https://docs.google.com/forms/d/e/1FAIpQLSe3NbhPL-AN69QPShj0J7FksiZLABLKlmn8US_qWaJRy_RFYw/viewform?usp=pp_url";

  // Encode the product name and points for URL safety
  const params = new URLSearchParams();
  params.append(productEntry, name);
  params.append(pointsEntry, points);

  // Open the Google Form in a new tab with pre-filled values
  window.open(`${baseURL}&${params.toString()}`, '_blank');
}


  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', loadProducts);
</script>
</body>
</html>