<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redeem Page</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">
  <h1>CHOOSE AN ITEM TO REDEEM WITH CREDITS</h1>

  <div class="search-filter">
    <input id="searchInput" type="text" placeholder="Search by name or description..." />
    <select id="sortFilter" style="border: 2px solid #ddd; ">
      <option value="">Sort by</option>
      <option value="low-high">Credits: Low to High</option>
      <option value="high-low">Credits: High to Low</option>
    </select>
  </div>

  <div id="productList">
    <div class="loading">Loading products...</div>
  </div>
</div>

<!-- Popup -->
<div class="popup" id="popup">
  <div class="popup-content">
    <h2 id="popup-title"></h2>
    <p id="popup-desc"></p>
    <button class="close-btn" onclick="closePopup()">Close</button>
  </div>
</div>

<script>
  // Load products from JSON file only
  async function loadProducts() {
    try {
      const response = await fetch('products.json');
      if (response.ok) {
        const products = await response.json();
        displayProducts(products);
      } else {
        throw new Error('products.json not found');
      }
    } catch (error) {
      console.log('Error loading products:', error);
      // Show error message if products.json is not found
      const productList = document.getElementById('productList');
      productList.innerHTML = '<div class="loading">No products found. Please make sure products.json exists.</div>';
    }
  }

  // Display products on the page
  function displayProducts(products) {
    const productList = document.getElementById('productList');
    
    if (products.length === 0) {
      productList.innerHTML = '<div class="loading">No products available</div>';
      return;
    }
    
    productList.innerHTML = '';
    
    products.forEach(product => {
      const productDiv = document.createElement('div');
      productDiv.className = 'product';
      productDiv.innerHTML = `
        <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Found'">
        <div class="product-info">
          <div class="product-name">${product.name}</div>
          <div class="product-desc">${product.description}</div>
        </div>
        <div class="credits">${product.credits} credits</div>
        <button class="redeem-btn" onclick="redeemProduct('${product.name.replace(/'/g, "\\'")}', '${product.credits} credits')">REDEEM NOW</button>
      `;
      productList.appendChild(productDiv);
    });
    
    // Initialize filtering and description truncation
    initializeFilters();
    applyDescriptionTruncation();
  }

  // Initialize search and filter functionality
  function initializeFilters() {
    const productList = document.getElementById('productList');
    const searchInput = document.getElementById('searchInput');
    const sortFilter = document.getElementById('sortFilter');
    
    const originalItems = Array.from(productList.querySelectorAll('.product'));

    function readCredits(el) {
      const txt = el.querySelector('.credits')?.textContent || '';
      const n = parseInt(txt.replace(/[^\d]/g, ''), 10);
      return Number.isNaN(n) ? 0 : n;
    }

    function readSearchText(el) {
      const name = el.querySelector('.product-name')?.textContent || '';
      const desc = el.querySelector('.product-desc')?.textContent || '';
      return (name + ' ' + desc).toLowerCase();
    }

    function applyFilterAndSort() {
      const q = searchInput.value.trim().toLowerCase();
      const sortOrder = sortFilter.value;

      let filtered = originalItems.filter(el => {
        return readSearchText(el).includes(q);
      });

      if (sortOrder === 'low-high') {
        filtered.sort((a, b) => readCredits(a) - readCredits(b));
      } else if (sortOrder === 'high-low') {
        filtered.sort((a, b) => readCredits(b) - readCredits(a));
      }

      productList.innerHTML = '';
      filtered.forEach(el => {
        productList.appendChild(el);
      });
      
      applyDescriptionTruncation();
    }

    searchInput.addEventListener('input', applyFilterAndSort);
    sortFilter.addEventListener('change', applyFilterAndSort);
  }

  // Description truncation + "click for more" popup
  function applyDescriptionTruncation() {
    document.querySelectorAll('.product-desc').forEach(desc => {
      const fullText = desc.getAttribute('data-full') || desc.textContent.trim();
      desc.setAttribute('data-full', fullText);
      const maxLen = 120;
      if (fullText.length > maxLen) {
        const shortText = fullText.slice(0, maxLen) + '... ';
        desc.innerHTML = '';
        desc.appendChild(document.createTextNode(shortText));
        const moreLink = document.createElement('span');
        moreLink.textContent = 'click for more';
        moreLink.classList.add('click-more');
        moreLink.onclick = () => openPopup(desc.closest('.product').querySelector('.product-name').textContent, fullText);
        desc.appendChild(moreLink);
      } else {
        desc.textContent = fullText;
      }
    });
  }

  // Popup functions
  function openPopup(name, desc) {
    document.getElementById('popup-title').textContent = name;
    document.getElementById('popup-desc').textContent = desc;
    document.getElementById('popup').style.display = 'flex';
  }

  function closePopup() {
    document.getElementById('popup').style.display = 'none';
  }

  // Redeem button function
  function redeemProduct(name, credits) {
    const email = "naziaputul.207@gmail.com";
    const subject = `request to redeem ${name}`;
    const body = `Greetings,%0D%0A%0D%0AI would like to redeem ${name} for ${credits}. Thank you.%0D%0A%0D%0AWarm regards,%0D%0AName : %0D%0ANumber : `;
    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${email}&su=${subject}&body=${body}`, '_blank');
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', loadProducts);
</script>
</body>
</html>